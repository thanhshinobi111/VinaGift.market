<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>K·∫øt n·ªëi v√≠ TON - VinaGift</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"> <!-- Th√™m viewport ƒë·ªÉ t·ªëi ∆∞u tr√™n di ƒë·ªông -->
  <script src="https://unpkg.com/@tonconnect/ui@latest/dist/tonconnect-ui.min.js"></script>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f0f0f0;
      padding: 20px;
      text-align: center;
      margin: 0; /* X√≥a margin m·∫∑c ƒë·ªãnh */
    }
    #connect-button {
      margin: 20px auto;
    }
    #wallet-info {
      margin-top: 20px;
      font-weight: bold;
      word-break: break-all; /* ƒê·∫£m b·∫£o ƒë·ªãa ch·ªâ v√≠ kh√¥ng tr√†n */
    }
    #marketplace-link {
      display: none;
      margin-top: 20px;
    }
    #marketplace-link a {
      color: #007bff;
      text-decoration: none;
      font-weight: bold;
    }
  </style>
</head>
<body>
  <h1>üîó K·∫øt n·ªëi v√≠ TON</h1>
  <div id="connect-button"></div>
  <p id="wallet-info"></p>
  <div id="marketplace-link">
    <a href="https://vinagift.netlify.app/marketplace">Truy c·∫≠p Marketplace</a>
  </div>

  <script>
    const telegramWebApp = window.Telegram?.WebApp;
    let walletAddress = "";

    // Kh·ªüi t·∫°o Telegram WebApp n·∫øu c√≥
    if (telegramWebApp) {
      telegramWebApp.ready();
    }

    const tonConnectUI = new TON_CONNECT_UI.TonConnectUI({
      manifestUrl: 'https://vinagift.netlify.app/tonconnect-manifest.json', // Th·ªëng nh·∫•t URL
      buttonRootId: 'connect-button'
    });

    tonConnectUI.onStatusChange((walletInfo) => {
      if (walletInfo && walletInfo.account) {
        walletAddress = walletInfo.account.address;
        document.getElementById('wallet-info').innerText = '‚úÖ ƒê√£ k·∫øt n·ªëi v√≠: ' + walletAddress;

        // Ki·ªÉm tra m√¥i tr∆∞·ªùng (Telegram WebApp hay tr√¨nh duy·ªát)
        if (telegramWebApp && telegramWebApp.initDataUnsafe && telegramWebApp.initDataUnsafe.user) {
          // Ch·∫°y trong Telegram WebApp: G·ª≠i d·ªØ li·ªáu v·ªÅ bot
          try {
            const userId = telegramWebApp.initDataUnsafe.user.id;
            telegramWebApp.sendData(
              JSON.stringify({
                type: "wallet_address",
                address: walletAddress,
                user_id: userId
              })
            );
            telegramWebApp.close(); // ƒê√≥ng WebApp
          } catch (error) {
            console.error("L·ªói khi g·ª≠i d·ªØ li·ªáu v·ªÅ bot:", error);
            document.getElementById('wallet-info').innerText = '‚ùå L·ªói khi g·ª≠i ƒë·ªãa ch·ªâ v√≠!';
          }
        } else {
          // Ch·∫°y ngo√†i Telegram (tr√¨nh duy·ªát): Hi·ªÉn th·ªã link ƒë·∫øn marketplace
          document.getElementById('wallet-info').innerText = '‚úÖ ƒê√£ k·∫øt n·ªëi v√≠: ' + walletAddress + '\nB·∫°n c√≥ th·ªÉ truy c·∫≠p Marketplace.';
          document.getElementById('marketplace-link').style.display = 'block';

          // L∆∞u ƒë·ªãa ch·ªâ v√≠ v√†o localStorage ƒë·ªÉ s·ª≠ d·ª•ng trong marketplace
          localStorage.setItem('connectedWalletAddress', walletAddress);
        }
      } else {
        document.getElementById('wallet-info').innerText = '';
        document.getElementById('marketplace-link').style.display = 'none';
      }
    });
  </script>
</body>
</html>